# 填到openwrt的计划任务即可
# 保存计划任务后请务必重启一次路由器，否则可能不会生效
# 可使用ssh测试（sh -c...或curl...）运行成功后无输出，运行错误会有提示


# 解决 UrlTest 策略组长时间运行后失效问题（不重启不断网）
# openclash 定时热加载配置刷新 UrlTest 测速

# 1.通用需替换两个地址密钥:curl -X POST "http://192.1.1.1:1234/configs" -H "Authorization: Bearer 12345"
00 */1 * * * sleep 70 && curl -X POST "http://127.0.0.1:9090/configs" -H "Authorization: Bearer admin" -H "Content-Type: application/json" -d '{"path":"/etc/openclash/config.yaml"}'; sleep 5; curl -X PUT "http://127.0.0.1:9090/configs?force=true" -H "Authorization: Bearer admin" -H "Content-Type: application/json" -d '{"path":"","payload":""}'

# 2.自动获取配置地址:某些固件可能无法正常运行
00 */1 * * * sleep 70 && sh -c "find /etc/openclash -type f -name '*.yaml' -print0 | while IFS= read -r -d '' file; do EC=\$(sed -n '/^[[:space:]]*external-controller:/{s/^[[:space:]]*external-controller:[[:space:]]*//p;q}' \"\$file\" | tr -d ' '); [ -z \"\$EC\" ] && continue; SECRET=\$(sed -n '/^[[:space:]]*secret:/{s/^[[:space:]]*secret:[[:space:]]*//p;q}' \"\$file\" | tr -d ' '); if curl -sS --connect-timeout 5 -o /dev/null -w '%{http_code}' \"http://\${EC}/configs\" \${SECRET:+-H \"Authorization: Bearer \${SECRET}\"} | grep -q '^2'; then curl -sS -X POST \"http://\${EC}/configs?force=true\" \${SECRET:+-H \"Authorization: Bearer \${SECRET}\"} -H \"Content-Type: application/json\" -d \"{\\\"path\\\":\\\"\$file\\\"}\" && curl -sS -X PUT \"http://\${EC}/configs\" \${SECRET:+-H \"Authorization: Bearer \${SECRET}\"} -H \"Content-Type: application/json\" -d '{\"action\":\"reload\"}'; exit 0; fi; done"


# 解决 流媒体增强 检测长时间运行后失效问题（不重启不断网）
# openclash 运行时定时重载防火墙，刷新解锁检测

# 1.定时检查 openclash 进程运行时重载防火墙
00 5 * * * sleep 70 && sh -c 'if pgrep clash >/dev/null 2>&1; then rm -rf /etc/openclash/history/streaming_unlock_cache >/dev/null 2>&1 && /etc/init.d/firewall reload >/dev/null 2>&1; else echo "Error: clash is not running" >&2; exit 1; fi'
